/*! version:1.4.13 */
define(function(){return function(t){function i(a){if(n[a])return n[a].exports;var e=n[a]={i:a,l:!1,exports:{}};return t[a].call(e.exports,e,e.exports,i),e.l=!0,e.exports}var n={};return i.m=t,i.c=n,i.d=function(t,n,a){i.o(t,n)||Object.defineProperty(t,n,{configurable:!1,enumerable:!0,get:a})},i.n=function(t){var n=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(n,"a",n),n},i.o=function(t,i){return Object.prototype.hasOwnProperty.call(t,i)},i.p="./dist/dmap/leaflet/",i(i.s=160)}({160:function(t,i,n){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var a=n(161);i.default=function(t){return new a.a(t)}},161:function(t,i,n){"use strict";var a=n(162),e=L,o=e.DomUtil,r=o.setTransform,s=function(t,i){for(var n=[],a=255;a>=255;a-=3)n.push("rgba("+a+", "+a+", "+a+", 0.8)");return n.indexFor=function(t){return Math.floor(Math.min(t,i)/i*(n.length-1))},n};i.a=L.Layer.extend({options:{showdetails:!1,dataType:"wind",pane:"shadowPane",windyStaticOpts:{isTOverlayer:!1,intensityColorScale:s,drawOverlay:!0,OVERLAY_ALPHA:130,PARTICLE_MULTIPLIER:6,MAX_PARTICLE_AGE:100}},initialize:function(t){L.setOptions(this,t),this._windyFactorieOpts=this.options.windyFactorieOpts||{}},onAdd:function(t){this._map=t,this._animationCanvas=this._createCanvas(),this._overlayCanvas=this._createCanvas("windy",this.options.drawOverlay),this._overlayCanvas.style.zIndex="0",t.on("resize",this._resize,this).on("moveend",this._reset,this),t.options.zoomAnimation&&L.Browser.any3d&&t.on("zoomanim",this._animateZoom,this),this.options.showdetails&&t.on("click",this._showLocationDetails,this),this._updataPostions(),this._reset()},onRemove:function(t){var i=t.options,n=i.showdetails,a=i.zoomAnimation,e=this.getPane();t.off("resize",this._resize,this).off("moveend",this._reset,this),n&&t.off("click",this._showLocationDetails,this),a&&t.off("zoomanim",this._animateZoom,this),this._windy&&(this._windy.stop(),this._windy=null),e.removeChild(this._animationCanvas),e.removeChild(this._overlayCanvas),this._animationCanvas=null,this._overlayCanvas=null},_createCanvas:function(t,i){var n=T.canvas("leaflet-canvas-layer "+(t||"")),a=this._map.getSize();n.width=a.x,n.height=a.y;var e=this._map.options.zoomAnimation&&L.Browser.any3d;return o.addClass(n,"leaflet-zoom-"+(e?"animated":"hide")),!1!==i&&this.getPane().appendChild(n),n},_animateZoom:function(t){this._updataPostions(t.center,t.zoom)},_updataPostions:function(t,i){var n=this._map;t=t||n.getCenter(),i=i||n.getZoom();var a=n.getZoomScale(i),e=o.getPosition(this._overlayCanvas),s=n.getSize().multiplyBy(.5),l=n.project(n.getCenter(),i),h=n.project(t,i),u=h.subtract(l),c=s.multiplyBy(-a).add(e).add(s).subtract(u);r(this._animationCanvas,c,a),r(this._overlayCanvas,c,a)},_resize:function(t){var i=t.newSize,n=i.x,a=i.y;this._animationCanvas.width=n,this._animationCanvas.height=a,this._overlayCanvas.width=n,this._overlayCanvas.height=a,this._reset()},_reset:function(){this._redraw()},loadWindy:function(t){var i=this._map;if(!i)return void(this.gfs=t);var n=i.getBounds(),e=i.getSize(),o=i.getZoom();this._windy?this.gfs!==t&&this._windy.update(t,[[0,0],[e.x,e.y]],e.x,e.y,[[n._southWest.lng,n._southWest.lat],[n._northEast.lng,n._northEast.lat]],o):this._windy=new a.a(T.assign({animation:this._animationCanvas,overlay:this._overlayCanvas,data:t,dataType:this.options.dataType,factorie:this._windyFactorieOpts,drawOverlay:!0},this.options.windyStaticOpts)),this._windy.start([[0,0],[e.x,e.y]],e.x,e.y,[[n._southWest.lng,n._southWest.lat],[n._northEast.lng,n._northEast.lat]],o),this.gfs=t},clearWindy:function(){if(this._windy){this._windy.stop(),delete this._windy;var t=this.map.getSize(),i=t.x,n=t.y;this._animationCanvas.getContext("2d").clearRect(0,0,i,n),this._overlayCanvas.getContext("2d").clearRect(0,0,i,n)}},_redraw:function(){var t=this._windy,i=this._map,n=this._animationCanvas,a=this._overlayCanvas;if(t){var e=i.containerPointToLayerPoint([0,0]);o.setPosition(n,e),o.setPosition(a,e);var r=i.getSize(),s=i.getBounds(),l=i.getZoom();this._windy.start([[0,0],[r.x,r.y]],r.x,r.y,[[s._southWest.lng,s._southWest.lat],[s._northEast.lng,s._northEast.lat]],l)}},_showLocationDetails:function(t){if(this._windy){var i=this.getLocationDetails(t.latlng,t.containerPoint);i&&this.fire("pushdetails",{details:i})}},getLocationDetails:function(t,i){return this._windy?this._windy.getLocationDetails(t,i):null}})},162:function(t,i,n){"use strict";function a(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}var e=n(163),o=n(164),r=T,s=r.assign,l=r.isNumber,h=r.isNumeric,u=r.isArray,c=r.random,d=L.Util,f=d.requestAnimFrame,v=d.cancelAnimFrame,p=100,_=25,y=Math.floor(102),g=10,m=100,w=1,M=7,x=.75,C=40,E=[NaN,NaN,null],A=[NaN,NaN,null],I=[0,0,0,0],b=function(){function t(i){a(this,t),this.options={dataType:"wind"},i=this.options=s(this.options,i),this._intensityColorScale=i.intensityColorScale,p=l(i.MAX_TASK_TIME)?i.MAX_TASK_TIME:p,_=l(i.MIN_SLEEP_TIME)?i.MIN_SLEEP_TIME:_,y=l(i.OVERLAY_ALPHA)?i.OVERLAY_ALPHA:y,g=l(i.INTENSITY_SCALE_STEP)?i.INTENSITY_SCALE_STEP:g,m=l(i.MAX_PARTICLE_AGE)?i.MAX_PARTICLE_AGE:m,w=l(i.PARTICLE_LINE_WIDTH)?i.PARTICLE_LINE_WIDTH:w,M=l(i.PARTICLE_MULTIPLIER)?i.PARTICLE_MULTIPLIER:M,x=l(i.PARTICLE_REDUCTION)?i.PARTICLE_REDUCTION:x,C=l(i.FRAME_RATE)?i.FRAME_RATE:C,i.data&&this.load(i.data)}return t.prototype.load=function(t){this.stop();var i=this.options,n=this.options.animation;if(n){var a=n.width,o=n.height;n.getContext("2d").clearRect(0,0,a,o),i.overlay.getContext("2d").clearRect(0,0,a,o)}var r=s(k[this.options.dataType],this.options.factorie);r.gradientColors&&u(r.gradientColors)&&(r.scale.gradient=e.a.segmentedColorScale(r.gradientColors),delete r.gradientColors),this._product=s(O(r.builder(t,this.options.isTOverlayer)),r)},t.prototype.start=function(t,i,n,a,r){this._product&&(this.stop(),this._latlngBounds={south:e.a.deg2rad(a[0][1]),north:e.a.deg2rad(a[1][1]),east:e.a.deg2rad(a[1][0]),west:e.a.deg2rad(a[0][0]),width:i,height:n,zoom:r},this.options.animation.getContext("2d").clearRect(0,0,i,n),this.options.overlay.getContext("2d").clearRect(0,0,i,n),this._id=Date.now()+c(-100,100),o.a.on("windy:"+this._id,this._animate,this),this._bounds=z(t,i,n),this._playing=!0,V(this))},t.prototype._animate=function(t){function i(){h.forEach(function(t){t.length=0}),v.forEach(function(t){t.age>m&&(r.randomize(t).age=0);var i=t.x,n=t.y,a=r(i,n),e=a[2];if(null===e)t.age=m;else{var o=i+a[0],s=n+a[1];r.isDefined(o,s)?(t.xt=o,t.yt=s,h[l.indexFor(e)].push(t)):(t.x=o,t.y=s)}t.age+=1})}function n(){var t=_.globalCompositeOperation;_.globalCompositeOperation="destination-in",_.fillRect(a.x,a.y,a.width,a.height),_.globalCompositeOperation=t,_.restore(),h.forEach(function(t,i){t.length>0&&(_.beginPath(),_.strokeStyle=l[i],t.forEach(function(t){_.moveTo(t.x,t.y),_.lineTo(t.xt,t.yt),t.x=t.xt,t.y=t.yt}),_.stroke())})}this._field=t.field;var a=this._bounds,o=this._latlngBounds,r=this._field,s=this._product,l=(this._intensityColorScale||e.a.windIntensityColorScale)(g,s.particles.maxIntensity),h=l.map(function(){return[]}),u=Math.round(o.width*M*(1/Math.pow(1.6,o.zoom-2)));T.isMobile()&&(u*=x);for(var d=e.a.isFF()?"rgba(0, 0, 0, 0.95)":"rgba(0, 0, 0, 0.97)",v=[],p=0;u>p;p++)v.push(r.randomize({age:c(0,m)}));if(this.options.drawOverlay){this.options.overlay.getContext("2d").putImageData(r.overlay,0,0)}var _=this.options.animation.getContext("2d");_.lineWidth=w,_.fillStyle=d;var y=void 0,E=Date.now(),L=this;!function t(){L.animationLoop=f(t);var a=Date.now();(y=a-E)>C&&(E=a-y%C,i(),n())}()},t.prototype.updateOverlayAlpha=function(t){y=t,this._field&&(this._field.release(),delete this._field),this.animationLoop&&(v(this.animationLoop),delete this.animationLoop);var i=this._latlngBounds.width,n=this._latlngBounds.height;this.options.animation.getContext("2d").clearRect(0,0,i,n),this.options.overlay.getContext("2d").clearRect(0,0,i,n),V(this)},t.prototype.update=function(t,i,n,a,e,o){this.options.data=t,this.load(t),this.start(i,n,a,e,o)},t.prototype.stop=function(){this._playing=!1,this._field&&(this._field.release(),delete this._field),this.animationLoop&&(v(this.animationLoop),this.animationLoop),delete this._latlngBounds,delete this._bounds,this._offObserver()},t.prototype.dispose=function(){this.stop(),delete this._product},t.prototype._offObserver=function(){this._id&&(o.a.off("windy:"+this._id),delete this._id)},t.prototype.getLocationDetails=function(t,i){if(!(t&&this._product&&this._field&&this._field.isUVDefined(i.x,i.y)))return null;var n=this._product.interpolate(t.lng,t.lat),a=n[2];return e.a.isValue(n)&&a<this._product.maxlimitValue?{animationVal:e.a.formatVector([n[0],n[1],a],this._product.unit),overlayVal:this._field.isTOverlayer?n[3]:a}:null},t}();i.a=b;var P=function(t,i,n,a,e,o){var r=1-t,s=1-i,l=r*s,h=t*s,u=r*i,c=t*i,d=n[0]*l+a[0]*h+e[0]*u+o[0]*c,f=n[1]*l+a[1]*h+e[1]*u+o[1]*c;return[d,f,Math.sqrt(d*d+f*f)]},S=function(t,i,n,a,e,o){var r=1-t,s=1-i,l=r*s,h=t*s,u=r*i,c=t*i,d=n[0]*l+a[0]*h+e[0]*u+o[0]*c,f=n[1]*l+a[1]*h+e[1]*u+o[1]*c,v=n[2]*l+a[2]*h+e[2]*u+o[2]*c;return[d,f,Math.sqrt(d*d+f*f),v]},O=function(t){function i(i,n){var l,h=e.a.floorMod(i-a,360)/r,u=(o-n)/s,d=Math.floor(h),f=d+1,v=Math.floor(u),p=v+1;if(l=c[v]){var _=l[d],y=l[f];if(e.a.isValue(_)&&e.a.isValue(y)&&(l=c[p])){var g=l[d],m=l[f];if(e.a.isValue(g)&&e.a.isValue(m))return t.interpolate(h-d,u-v,_,y,g,m)}}return null}var n=t.header,a=n.lo1,o=n.la1,r=n.dx,s=n.dy,l=n.nx,h=n.ny,u=new Date(n.refTime);u.setHours(u.getHours()+n.forecastTime);for(var c=[],d=0,f=Math.floor(l*r)>=360,v=0;h>v;v++){for(var p=[],_=0;l>_;_++,d++)p[_]=t.data(d);f&&p.push(p[0]),c[v]=p}return{date:u,interpolate:i,forEachPoint:function(t){for(var i=0;h>i;i++)for(var n=c[i]||[],u=0;l>u;u++)t(e.a.floorMod(180+a+u*r,360)-180,o-i*s,n[u])}}},R=function(t,i){return h(t)||1/0===t||t===-1/0?t:i},z=function(t,i,n){var a=t[0],e=t[1],o=Math.max(Math.floor(R(a[0],0)),0),r=Math.max(Math.floor(R(a[1],0)),0),s=Math.min(Math.ceil(e[0],i),i-1),l=Math.min(Math.ceil(e[1],n),n-1);return{x:o,y:r,xMax:s,yMax:l,width:s-o+1,height:l-r+1}},D=function t(i){var n=i.width,a=i.height,e=t.canvas=T.canvas();e.width=n,e.height=a;var o=e.getContext("2d"),r=o.createImageData(n,a),s=r.data;return{imageData:r,set:function(t,i,a){var e=4*(i*n+t);return s[e]=a[0],s[e+1]=a[1],s[e+2]=a[2],s[e+3]=a[3],this}}},V=function(t){function i(t){for(var i=[],n=a.y;n<=a.yMax;n+=2){var o=e.a.invert(t,n,r),l=I,u=null;if(o){var v=o[0],p=o[1];if(isFinite(v)){u=g(v,p);var _=null;u&&(_=w&&u.length>3?u[3]:u[2],u=e.a.distort(v,p,t,n,c,u,r)),e.a.isValue(_)&&(l=!s||s>=_?m.gradient(_,y):h||l)}}i[n+1]=i[n]=u||A,d.set(t,n,l).set(t+1,n,l).set(t,n+1,l).set(t+1,n+1,l)}f[t+1]=f[t]=i}var n=t._product,a=t._bounds,r=t._latlngBounds,s=t._product.maxlimitValue,h=t._product.maxlimitValueColor,u=t._id;if(!n)return null;var c=l(n.particles.velocityScale)?a.height*n.particles.velocityScale:n.particles.velocityScale({height:a.height,width:a.width,zoom:r.zoom}),d=D(a),f=[],v=a.x,g=n.interpolate,m=n.scale,w=t.options.isTOverlayer;!function n(){try{if(t._playing){for(var e=Date.now();v<a.xMax;)if(i(v),v+=2,Date.now()-e>p)return void setTimeout(n,_);o.a.trigger("windy:"+u,{field:N(f,a,d,t.options.isTOverlayer)})}}catch(t){console.warn(t)}}()},N=function(t,i,n,a){function e(i,n){var a=t[Math.round(i)];return a&&a[Math.round(n)]||E}return e.isDefined=function(t,i){return null!==e(t,i)[2]},e.isInsideBoundary=function(t,i){return e(t,i)!==E},e.release=function(){t=[]},e.randomize=function(t){var n,a,o=0;do{n=Math.round(c(i.x,i.xMax)),a=Math.round(c(i.y,i.yMax))}while(!e.isDefined(n,a)&&o++<30);return t.x=n,t.y=a,t},e.overlay=n.imageData,e.isTOverlayer=a,e.isUVDefined=function(t,i){if(e.isTOverlayer){var n=e(t,i);return null!==Math.sqrt(n[0]*n[0]+n[1]*n[1])}return null!==e(t,i)[2]},e},k={wind:{field:"vector",type:"wind",builder:function(t,i){var n=t[0].data,a=t[1].data,e=3===t.length?t[2].data:null;return{header:t[0].header,interpolate:i&&e?S:P,data:function(t){var i=e?e[t]:null;return[n[t],a[t],i]}}},unit:{label:"km/h",conversion:function(t){return 3.6*t},precision:0},scale:{bounds:[0,100],gradient:function(t,i){return e.a.extendedSinebowColor(Math.min(t,100)/100,i)}},particles:{velocityScale:function(t){return t.height/(4e4*Math.pow(1.6,t.zoom-3))*1},maxIntensity:17}},currents:{field:"vector",type:"currents",builder:function(t,i){var n=t[0].data,a=t[1].data,o=3===t.length?t[2].data:null;return{header:t[0].header,interpolate:i&&o?S:P,data:function(t){var i=n[t],r=a[t],s=o?o[t]:null;return e.a.isValue(i)&&e.a.isValue(r)?[i,r,s]:null}}},unit:{label:"m/s",conversion:function(t){return t},precision:2},scale:{bounds:[0,1.5],gradient:e.a.segmentedColorScale([[0,[10,25,68]],[.15,[10,25,250]],[.4,[24,255,93]],[.65,[255,233,102]],[1,[255,233,15]],[1.5,[255,15,15]]])},maxlimitValue:20,particles:{velocityScale:1/4400,maxIntensity:.7}}}},163:function(t,i,n){"use strict";function a(t,i){var n=t[0],a=t[1],e=t[2],o=i[0]-n,r=i[1]-a,s=i[2]-e;return function(t,i){return[Math.floor(n+t*o),Math.floor(a+t*r),Math.floor(e+t*s),i]}}function e(t,i){var n=t*c*5/6;n*=.75;var a=Math.sin(n),e=Math.cos(n);return[Math.floor(255*Math.max(0,-e)),Math.floor(255*Math.max(a,0)),Math.floor(255*Math.max(e,0,-a)),i]}function o(t,i){return d>=t?e(t/d,i):f((t-d)/(1-d),i)}function r(t,i,n,a){return"rgba("+t+", "+i+", "+n+", "+a+")"}function s(t,i){for(var n=[],a=85;255>=a;a+=t)n.push(r(a,a,a,1));return n.indexFor=function(t){return Math.floor(Math.min(t,i)/i*(n.length-1))},n}function l(t){for(var i=[],n=[],e=[],o=0;o<t.length-1;o++)i.push(t[o+1][0]),n.push(a(t[o][1],t[o+1][1])),e.push([t[o][0],t[o+1][0]]);return function(t,a){var o;for(o=0;o<i.length-1&&!(t<=i[o]);o++);var r=e[o];return n[o](u(t,r[0],r[1]),a)}}function h(t,i,n){return Math.max(i,Math.min(t,n))}function u(t,i,n){return(h(t,i,n)-i)/(n-i)}var c=2*Math.PI,d=.45,f=a(e(1,0),[255,255,255]),v=function(t,i){var n=t-i*Math.floor(t/i);return n===i?0:n},p=function(t){return null!==t&&void 0!==t},_=function(){return/firefox/i.test(navigator.userAgent)},y=function(t,i,n){var a=n.east-n.west,e=n.width/m(a)*360/(2*Math.PI),o=e/2*Math.log((1+Math.sin(n.south))/(1-Math.sin(n.south))),r=n.height+o,s=(r-i)/e,l=180/Math.PI*(2*Math.atan(Math.exp(s))-Math.PI/2);return[m(n.west)+t/n.width*m(a),l]},g=function(t){return t/180*Math.PI},m=function(t){return t/(Math.PI/180)},w=function(t){return Math.log(Math.tan(t/2+Math.PI/4))},M=function(t,i,n){var a=w(n.south),e=w(n.north),o=n.width/(n.east-n.west),r=n.height/(e-a),s=w(g(t)),l=(g(i)-n.west)*o;return s=(e-s)*r,[l,s]},x=function(t,i,n,a,e,o,r){var s=o[0]*e,l=o[1]*e,h=C(t,i,n,a,r);return o[0]=h[0]*s+h[2]*l,o[1]=h[1]*s+h[3]*l,o},C=function(t,i,n,a,e){var o=Math.pow(10,-5.2),r=0>t?o:-o,s=0>i?o:-o,l=M(i,t+r,e),h=M(i+s,t,e),u=Math.cos(i/360*c);return[(l[0]-n)/r/u,(l[1]-a)/r/u,(h[0]-n)/s,(h[1]-a)/s]},T=function(t,i){return i.conversion(t).toFixed(i.precision)},E=function(t,i){return T(t[2],i)+i.label};i.a={isFF:_,isValue:p,floorMod:v,deg2rad:g,rad2deg:m,mercY:w,project:M,invert:y,distort:x,distortion:C,sinebowColor:e,extendedSinebowColor:o,windIntensityColorScale:s,segmentedColorScale:l,formatVector:E}},164:function(t,i,n){"use strict";function a(t,i,n){n?f[t]=i[t]:delete f[t]}function e(t,i,n){if(!(t||l(t)||c(t)||u(t)))throw"输入的参数必须是字符串或字符串数组";u(t)||(t=[t]);var e=[];for(var o in n)e.push(o);for(var r=0,s=t.length;s>r;r++){var h=t[r];if(!l(h)&&!c(h))throw"输入的参数的数组元素必须是字符串或正则表达式";if(c(h))for(var d=0,f=e.length;f>d;d++){var v=e[d];h.test(v)&&a(v,n,i)}else h in n&&a(h,n,i)}}function o(t,i,n,a){for(var e=t.slice(0),o=0,s=e.length;s>o;o++){var l=e[o];l.callback.apply(l.context||i,n),a&&r.log(l.stack)}}var r,s=T,l=s.isString,h=s.isFunction,u=s.isArray,c=s.isRegExp,d={},f={};if(window.console)r=window.console;else{var v=function(){};r={log:v,warn:v,error:v}}i.a={on:function(t,i,n){if(!l(t)||!h(i))throw"必须传入正确的name和callback参数";var a=d[t]||(d[t]=[]),e={callback:i,context:n||this};return a.push(e),this},once:function(t,i,n){if(!l(t)||!h(i))throw"必须传入正确的name和callback参数";var a=this,e=function e(){a.off(t,e),i.apply(n||a,arguments)};return e.callback=i,this.on(t,e),this},off:function(t,i,n){if(!(t||i||n))throw"必须传入name, callback, context等参数";if(!t||!l(t))throw"必须传入正确的name参数";if(i&&!h(i))throw"必须传入正确的callback参数";var a=d[t];if(!a)return this;if(!i&&!n)return delete d[t],this;for(var e=a.length-1;e>=0;e--){var o=a[e];(o.callback===i||o.callback.callback===i)&&(n&&o.context!==n||a.splice(e,1))}return this},offAll:function(){return d={},this},past:function(t,i,n){if(!l(t)||!h(i))throw"必须传入正确的name和callback参数";return f[t]&&i.apply(n||this,f[t]),this.on(t,i,n),this},trigger:function(t){if(!l(t))throw"必须传入正确的name参数";for(var i=[],n=1,a=arguments.length;a>n;n++)i.push(arguments[n]);f[t]=i;var e,r=d[t];r&&o(r,this,i,e);var s=d.all;return s&&o(s,this,i,e),this},clearAll:function(){f={}},clear:function(t){e(t,!1,f)},clearOther:function(t){var i=f;f={},e(t,!0,i)},_getLastArgs:function(){return f},_getSubscribers:function(){return d}}}})});
//# sourceMappingURL=windyLayer.js.map